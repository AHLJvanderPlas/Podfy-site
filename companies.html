<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Companies – Podfy</title>
  <meta name="description" content="Internal list of companies and theme settings from podfy.app." />
  <!-- Do not index or follow -->
  <meta name="robots" content="noindex, nofollow" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { brand: { DEFAULT:'#4B5563', accent:'#2563EB' }}}}}
  </script>

  <style>
    html { scroll-behavior: smooth; }
    .color-cell { font-weight:600; border-left: 1px solid rgba(0,0,0,.06); border-right: 1px solid rgba(0,0,0,.06); }
    .color-cell code { background: rgba(255,255,255,.2); padding: 2px 6px; border-radius: 6px }
    .logo-img { height: 24px; max-width: 200px; object-fit: contain }
    .favicon-img { width: 20px; height: 20px; object-fit: contain; border-radius: 4px }
    th, td { white-space: nowrap; }
  </style>
</head>
<body class="bg-white text-slate-800 antialiased">
  <!-- Header -->
  <header class="border-b border-slate-100">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <svg width="28" height="28" viewBox="0 0 64 64" class="text-brand" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 22l24-12 24 12v20L32 54 8 42V22Z"/><path d="M32 54V34"/>
            <path d="M14 36h10"/><path d="M24 36l6 4-6 4"/><path d="M38 36l4 5 8-10"/>
          </g>
        </svg>
        <span class="text-lg font-semibold tracking-tight text-brand">Podfy</span>
      </a>
      <nav class="text-sm">
        <a href="/" class="hover:text-brand mr-6">Home</a>
        <a href="/security.html" class="hover:text-brand mr-6">Security</a>
        <a href="/companies" class="text-brand font-medium">Companies</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-10">
    <h1 class="text-3xl font-bold">Companies</h1>
    <p class="mt-2 text-slate-600">
      Auto-loaded from <code>https://podfy.app/themes.json</code>. Favicon links are used from the JSON when present;
      otherwise we try <code>https://podfy.app/favicons/&lt;slug&gt;.(ico|png|svg)</code>. Logos are taken from JSON or
      <code>https://podfy.app/logos/&lt;slug&gt;.(svg|png|jpg|webp)</code>.
    </p>

    <div class="mt-6 flex items-center gap-3">
      <input id="search" placeholder="Filter by slug, name or any field…" class="w-full max-w-md rounded border px-3 py-2 text-sm" />
      <button id="refresh" class="rounded border px-3 py-2 text-sm hover:bg-slate-50">Refresh</button>
    </div>

    <div id="status" class="mt-4 text-sm text-slate-600">Loading…</div>

    <div class="mt-4 overflow-x-auto border rounded-xl">
      <table id="tbl" class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600"></thead>
        <tbody class="divide-y"></tbody>
      </table>
    </div>

    <p class="mt-3 text-xs text-slate-500">
      Notes: any field that looks like a color (hex/rgb/rgba/hsl) is rendered with that background; the code remains visible.
    </p>
  </main>

  <script>
    const ENDPOINT = "https://podfy.app/themes.json";
    const BASE = "https://podfy.app";

    const statusEl = document.getElementById('status');
    const thead = document.querySelector('#tbl thead');
    const tbody = document.querySelector('#tbl tbody');
    const search = document.getElementById('search');

    // --- Color detection & contrast helpers ---
    const HEX_RE = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i;
    const RGB_RE = /^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/i;
    const RGBA_RE = /^rgba\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*(0|0?\.\d+|1)\s*\)$/i;
    const HSL_RE = /^hsl\(\s*\d{1,3}\s*,\s*\d{1,3}%\s*,\s*\d{1,3}%\s*\)$/i;

    const looksLikeColor = v =>
      typeof v === 'string' && (HEX_RE.test(v) || RGB_RE.test(v) || RGBA_RE.test(v) || HSL_RE.test(v));
    const looksLikeUrl = v => typeof v === 'string' && /^https?:\/\//i.test(v);

    function hexToRgb(hex){
      let h = hex.replace('#','');
      if (h.length === 3) h = [...h].map(c=>c+c).join('');
      const n = parseInt(h,16);
      return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
    }
    function cssToRgb(c){
      if (HEX_RE.test(c)) return hexToRgb(c);
      if (RGB_RE.test(c) || RGBA_RE.test(c)) {
        const [r,g,b] = c.match(/\d+(\.\d+)?/g).map(Number);
        return { r, g, b };
      }
      if (HSL_RE.test(c)) {
        const [h,s,l] = c.match(/\d+(\.\d+)?/g).map(Number);
        return hslToRgb(h/360, s/100, l/100);
      }
      return null;
    }
    function hslToRgb(h, s, l) {
      const a = s * Math.min(l, 1 - l);
      const f = (n,k=(n+h)%1) => l - a * Math.max(-1, Math.min(k*6-3, 4-k*6, 1));
      return { r: Math.round(255*f(0)), g: Math.round(255*f(1)), b: Math.round(255*f(2)) };
    }
    function bestTextColor(bg){
      const rgb = cssToRgb(bg);
      if (!rgb) return '#111';
      const srgb = ['r','g','b'].map(k=>{
        let x = rgb[k]/255;
        return x <= 0.03928 ? x/12.92 : Math.pow(((x+0.055)/1.055), 2.4);
      });
      const L = 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
      return L > 0.5 ? '#111' : '#fff';
    }

    // --- Keys from JSON ---
    const logoKeysFromJson = ['logo','logoUrl','logoURL','logo_url','brandLogo','brand_logo'];
    const faviconKeysFromJson = ['favicon','faviconUrl','faviconURL','favicon_url','shortcutIcon','appleTouchIcon'];

    // --- Flatten helper so nested theme.color.primary also becomes a column ---
    function flatten(obj, prefix='', out={}) {
      Object.entries(obj || {}).forEach(([k,v])=>{
        const key = prefix ? `${prefix}.${k}` : k;
        if (v && typeof v === 'object' && !Array.isArray(v)) {
          flatten(v, key, out);
        } else {
          out[key] = v;
        }
      });
      return out;
    }

    function normalizeData(json){
      let rows = [];
      if (Array.isArray(json)) rows = json.slice();
      else rows = Object.entries(json||{}).map(([slug, cfg]) => ({ slug, ...cfg }));

      rows = rows.map(r=>{
        const flat = flatten(r);
        if (!flat.slug && r.slug) flat.slug = r.slug;
        if (!flat.slug && (flat.name || flat.brand)) {
          flat.slug = String(flat.name || flat.brand).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
        }
        return flat;
      });
      return rows;
    }

    // --- Columns: favicon first, then logo, then slug/name/brand, then color keys, then the rest ---
    function collectColumns(rows){
      const set = new Set();
      rows.forEach(r => Object.keys(r||{}).forEach(k => set.add(k)));
      const keys = [...set];

      const score = (k)=>{
        if (k === 'slug') return -700;
        if (k === 'name' || k === 'brand') return -600;
        if (k.toLowerCase().includes('color')) return -500;
        return k.startsWith('_') ? 100 : 0;
      };
      const rest = keys
        .filter(k => !['favicon','logo'].includes(k))
        .sort((a,b)=> score(a) - score(b) || a.localeCompare(b));

      // Inject our image columns at the very front
      return ['favicon','logo', ...rest];
    }

    // --- URL helpers + fallbacks ---
    function urlJoin(base, path) { return base.replace(/\/+$/, '') + '/' + path.replace(/^\/+/, ''); }

    function logoCandidates(slug) {
      const p = `logos/${slug}`;
      return [
        urlJoin(BASE, `${p}.svg`),
        urlJoin(BASE, `${p}.png`),
        urlJoin(BASE, `${p}.jpg`),
        urlJoin(BASE, `${p}.jpeg`),
        urlJoin(BASE, `${p}.webp`),
        `${BASE}//logos/${slug}.svg` // tolerate accidental double slash
      ];
    }
    function faviconCandidates(slug) {
      const p = `favicons/${slug}`;
      return [
        urlJoin(BASE, `${p}.ico`),
        urlJoin(BASE, `${p}.png`),
        urlJoin(BASE, `${p}.svg`)
      ];
    }

    function setImageWithFallback(img, urls) {
      const list = urls.filter(Boolean);
      let i = 0;
      function next() {
        if (i >= list.length) { img.replaceWith(document.createTextNode('')); return; }
        const url = list[i++];
        img.onerror = next;
        img.src = url;
      }
      next();
    }

    // --- Rendering ---
    function render(rows) {
      const q = (search.value||'').trim().toLowerCase();
      const filtered = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
      const cols = collectColumns(filtered);

      // header
      thead.innerHTML = '<tr>' + cols.map(c => `<th class="text-left px-3 py-2 font-semibold">${c}</th>`).join('') + '</tr>';

      // body
      tbody.innerHTML = filtered.map(r => {
        const slug = r.slug || '';
        // URLs provided in JSON?
        const faviconFromJson = Object.entries(r).find(([k,v]) => faviconKeysFromJson.includes(k) && looksLikeUrl(v))?.[1];
        const logoFromJson = Object.entries(r).find(([k,v]) => logoKeysFromJson.includes(k) && looksLikeUrl(v))?.[1];

        return '<tr>' + cols.map(c => {
          let v = r[c];

          // Injected favicon column (FIRST)
          if (c === 'favicon') {
            const urls = faviconFromJson ? [faviconFromJson] : faviconCandidates(slug);
            const data = urls.map(encodeURIComponent).join('|');
            return `<td class="px-3 py-2"><img class="favicon-img company-img" data-srcs="${data}" alt="${slug} favicon"></td>`;
          }

          // Injected logo column (SECOND)
          if (c === 'logo') {
            const urls = logoFromJson ? [logoFromJson] : logoCandidates(slug);
            const data = urls.map(encodeURIComponent).join('|');
            return `<td class="px-3 py-2"><img class="logo-img company-img" data-srcs="${data}" alt="${slug} logo"></td>`;
          }

          // If JSON itself contains a favicon/logo field, render as image
          if (faviconKeysFromJson.includes(c) && looksLikeUrl(v)) {
            return `<td class="px-3 py-2"><img src="${v}" alt="${slug} favicon" class="favicon-img"/></td>`;
          }
          if (logoKeysFromJson.includes(c) && looksLikeUrl(v)) {
            return `<td class="px-3 py-2"><img src="${v}" alt="${slug} logo" class="logo-img"/></td>`;
          }

          // Color fields: colored background
          if (looksLikeColor(v)) {
            const txt = bestTextColor(v);
            const border = txt === '#fff' ? 'rgba(255,255,255,.35)' : 'rgba(0,0,0,.12)';
            return `<td class="px-3 py-2 color-cell" style="background:${v}; color:${txt}; box-shadow: inset 0 0 0 1px ${border}">
                      <code>${String(v)}</code>
                    </td>`;
          }

          // Objects/arrays -> stringify
          if (v && typeof v === 'object') {
            try { v = JSON.stringify(v); } catch(e) { v = String(v); }
          }
          if (v == null) v = '';

          return `<td class="px-3 py-2 text-slate-700">${String(v)}</td>`;
        }).join('') + '</tr>';
      }).join('');

      // Load favicon/logo fallbacks after DOM insert
      document.querySelectorAll('img.company-img').forEach(img => {
        const list = decodeURIComponent(img.dataset.srcs || '').split('|').filter(Boolean).map(decodeURIComponent);
        setImageWithFallback(img, list);
      });

      statusEl.textContent = `${filtered.length} compan${filtered.length===1?'y':'ies'} shown`;
    }

    async function load() {
      statusEl.textContent = 'Loading…';
      try {
        const res = await fetch(ENDPOINT, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const json = await res.json();
        window.__companies = normalizeData(json);
        render(window.__companies);
      } catch (err) {
        statusEl.textContent = 'Could not load themes.json (' + (err.message||err) + ').';
      }
    }

    // Flatten + normalize already defined above
    document.getElementById('refresh').addEventListener('click', load);
    search.addEventListener('input', () => render(window.__companies||[]));
    load();
  </script>
</body>
</html>
